(cl:declaim (cl:optimize cl:debug cl:safety))
(cl:declaim (sb-ext:muffle-conditions sb-ext:compiler-note cl:style-warning))
(MODULE (LIST 'MSTRUCT)) 
(FLAG '(DEFSTRUCT) 'EVAL) 
(FLUID '(*FASTSTRUCTS)) 
(SWITCH (LIST 'FASTSTRUCTS)) 
(PUT 'DEFSTRUCT 'DEFINED-ON-LINE '97) 
(PUT 'DEFSTRUCT 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'DEFSTRUCT 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DM DEFSTRUCT (U)
    (PROG (INDX OPTIONS SLOT_FORMS NAME PREDICATE CONSTRUCTOR FUNCTIONS)
      (SETQ INDX 0)
      (SETQ OPTIONS (GET_DEFSTRUCT_OPTIONS (CADR U)))
      (COND
       ((CDR U)
        (SETQ SLOT_FORMS
                (PROG (SLOT FORALL-RESULT FORALL-ENDPTR)
                  (SETQ SLOT (CDDR U))
                  (COND ((NULL SLOT) (RETURN NIL)))
                  (SETQ FORALL-RESULT
                          (SETQ FORALL-ENDPTR
                                  (CONS
                                   ((LAMBDA (SLOT)
                                      (COND ((IDP SLOT) (LIST SLOT NIL))
                                            (T SLOT)))
                                    (CAR SLOT))
                                   NIL)))
                 LOOPLABEL
                  (SETQ SLOT (CDR SLOT))
                  (COND ((NULL SLOT) (RETURN FORALL-RESULT)))
                  (RPLACD FORALL-ENDPTR
                          (CONS
                           ((LAMBDA (SLOT)
                              (COND ((IDP SLOT) (LIST SLOT NIL)) (T SLOT)))
                            (CAR SLOT))
                           NIL))
                  (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
                  (GO LOOPLABEL)))))
      (SETQ NAME (CAR OPTIONS))
      (SETQ PREDICATE (ATSOC 'PREDICATE (CDR OPTIONS)))
      (COND (PREDICATE (SETQ PREDICATE (CDR PREDICATE))))
      (SETQ CONSTRUCTOR (ATSOC 'CONSTRUCTOR (CDR OPTIONS)))
      (COND (CONSTRUCTOR (SETQ CONSTRUCTOR (CDR CONSTRUCTOR))))
      (SETQ FUNCTIONS NIL)
      (COND
       (CONSTRUCTOR
        (SETQ FUNCTIONS
                (CONS
                 (BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO NAME CONSTRUCTOR SLOT_FORMS
                  PREDICATE)
                 FUNCTIONS))))
      (COND
       (PREDICATE
        (SETQ FUNCTIONS
                (CONS (BUILD_DEFSTRUCT_PREDICATE_FUNCTION NAME PREDICATE)
                      FUNCTIONS))))
      (SETQ INDX (COND (PREDICATE 1) (T 0)))
      (PROG (SLOT)
        (SETQ SLOT SLOT_FORMS)
       LAB
        (COND ((NULL SLOT) (RETURN NIL)))
        ((LAMBDA (SLOT)
           (PROGN
            (SETQ FUNCTIONS
                    (CONS (BUILD_DEFSTRUCT_ACCESSOR_MACRO (CAR SLOT) INDX)
                          FUNCTIONS))
            (SETQ INDX (PLUS INDX 1))))
         (CAR SLOT))
        (SETQ SLOT (CDR SLOT))
        (GO LAB))
      (SETQ FUNCTIONS (CONS (MKQUOTE NAME) FUNCTIONS))
      (RETURN (CONS 'PROGN (REVERSE FUNCTIONS))))) 
(PUT 'GET_DEFSTRUCT_OPTIONS 'NUMBER-OF-ARGS 1) 
(PUT 'GET_DEFSTRUCT_OPTIONS 'DEFINED-ON-LINE '128) 
(PUT 'GET_DEFSTRUCT_OPTIONS 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'GET_DEFSTRUCT_OPTIONS 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE GET_DEFSTRUCT_OPTIONS (U)
    (PROG (NAME OPTIONS PREDICATE CONSTRUCTOR)
      (COND ((PAIRP U) (PROGN (SETQ NAME (CAR U)) (SETQ OPTIONS (CDR U))))
            (T (PROGN (SETQ NAME U) (SETQ OPTIONS NIL))))
      (COND ((NOT (IDP NAME)) (ERROR 0 (LIST "bad defstruct name:" NAME))))
      (PROG (ENTRY)
        (SETQ ENTRY OPTIONS)
       LAB
        (COND ((NULL ENTRY) (RETURN NIL)))
        ((LAMBDA (ENTRY)
           (COND
            ((EQ ENTRY 'PREDICATE)
             (SETQ PREDICATE (INTERN (COMPRESS (APPEND (EXPLODE NAME) '(P))))))
            ((EQCAR ENTRY 'PREDICATE) (SETQ PREDICATE (CADR ENTRY)))
            ((EQ ENTRY 'CONSTRUCTOR)
             (SETQ CONSTRUCTOR
                     (INTERN
                      (COMPRESS (APPEND '(M A K E ! -) (EXPLODE NAME))))))
            ((EQCAR ENTRY 'CONSTRUCTOR) (SETQ CONSTRUCTOR (CADR ENTRY)))
            (T (ERROR 0 (LIST "bad defstruct option:" ENTRY)))))
         (CAR ENTRY))
        (SETQ ENTRY (CDR ENTRY))
        (GO LAB))
      (COND
       ((NULL CONSTRUCTOR)
        (SETQ CONSTRUCTOR
                (INTERN (COMPRESS (APPEND '(M A K E ! -) (EXPLODE NAME)))))))
      (RETURN
       (LIST NAME (CONS 'PREDICATE PREDICATE)
             (CONS 'CONSTRUCTOR CONSTRUCTOR))))) 
(PUT 'EXPLODEID 'NUMBER-OF-ARGS 1) 
(PUT 'EXPLODEID 'DEFINED-ON-LINE '149) 
(PUT 'EXPLODEID 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'EXPLODEID 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE EXPLODEID (X)
    (COND ((IDP X) (EXPLODE X))
          (T
           (PROG (ELT FORALL-RESULT FORALL-ENDPTR)
             (SETQ ELT (EXPLODE2 X))
            STARTOVER
             (COND ((NULL ELT) (RETURN NIL)))
             (SETQ FORALL-RESULT ((LAMBDA (ELT) (LIST '! ELT)) (CAR ELT)))
             (SETQ FORALL-ENDPTR (LASTPAIR FORALL-RESULT))
             (SETQ ELT (CDR ELT))
             (COND ((ATOM FORALL-ENDPTR) (GO STARTOVER)))
            LOOPLABEL
             (COND ((NULL ELT) (RETURN FORALL-RESULT)))
             (RPLACD FORALL-ENDPTR ((LAMBDA (ELT) (LIST '! ELT)) (CAR ELT)))
             (SETQ FORALL-ENDPTR (LASTPAIR FORALL-ENDPTR))
             (SETQ ELT (CDR ELT))
             (GO LOOPLABEL))))) 
(PUT 'BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO 'NUMBER-OF-ARGS 4) 
(PUT 'BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO 'DEFINED-ON-LINE '155) 
(PUT 'BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL GENERAL GENERAL) GENERAL)) 
(DE BUILD_DEFSTRUCT_CONSTRUCTOR_MACRO
    (NAME MACRO_NAME SLOT_FORMS HAS_PREDICATE)
    (PROG (DFLTS)
      (SETQ DFLTS
              (PROG (X FORALL-RESULT FORALL-ENDPTR)
                (SETQ X SLOT_FORMS)
                (COND ((NULL X) (RETURN NIL)))
                (SETQ FORALL-RESULT
                        (SETQ FORALL-ENDPTR
                                (CONS
                                 ((LAMBDA (X)
                                    (LIST 'CONS (MKQUOTE (CAR X)) (CADR X)))
                                  (CAR X))
                                 NIL)))
               LOOPLABEL
                (SETQ X (CDR X))
                (COND ((NULL X) (RETURN FORALL-RESULT)))
                (RPLACD FORALL-ENDPTR
                        (CONS
                         ((LAMBDA (X) (LIST 'CONS (MKQUOTE (CAR X)) (CADR X)))
                          (CAR X))
                         NIL))
                (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
                (GO LOOPLABEL)))
      (COND
       (HAS_PREDICATE
        (SETQ DFLTS (CONS (LIST 'CONS '(GENSYM) (MKQUOTE NAME)) DFLTS))))
      (RETURN
       (LIST 'PUTD (MKQUOTE MACRO_NAME) ''MACRO
             (MKQUOTE
              (LIST 'LAMBDA '($$$)
                    (LIST 'LIST ''DEFSTRUCTVECTOR
                          (LIST 'MKLIST
                                (LIST 'DEFSTRUCT_CONSTRUCTOR '(CDR $$$)
                                      (CONS 'LIST DFLTS)))))))))) 
(PUT 'MKLIST 'NUMBER-OF-ARGS 1) 
(PUT 'MKLIST 'DEFINED-ON-LINE '177) 
(PUT 'MKLIST 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'MKLIST 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE MKLIST (X) (CONS 'LIST X)) 
(PUT 'DEFSTRUCT_CONSTRUCTOR 'NUMBER-OF-ARGS 2) 
(PUT 'DEFSTRUCT_CONSTRUCTOR 'DEFINED-ON-LINE '179) 
(PUT 'DEFSTRUCT_CONSTRUCTOR 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'DEFSTRUCT_CONSTRUCTOR 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE DEFSTRUCT_CONSTRUCTOR (U DFLTS)
    (PROG (D FORALL-RESULT FORALL-ENDPTR)
      (SETQ D DFLTS)
      (COND ((NULL D) (RETURN NIL)))
      (SETQ FORALL-RESULT
              (SETQ FORALL-ENDPTR
                      (CONS
                       ((LAMBDA (D) (FIND_STRUCT_KEY (CAR D) U (CDR D)))
                        (CAR D))
                       NIL)))
     LOOPLABEL
      (SETQ D (CDR D))
      (COND ((NULL D) (RETURN FORALL-RESULT)))
      (RPLACD FORALL-ENDPTR
              (CONS ((LAMBDA (D) (FIND_STRUCT_KEY (CAR D) U (CDR D))) (CAR D))
                    NIL))
      (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
      (GO LOOPLABEL))) 
(PUT 'FIND_STRUCT_KEY 'NUMBER-OF-ARGS 3) 
(PUT 'FIND_STRUCT_KEY 'DEFINED-ON-LINE '182) 
(PUT 'FIND_STRUCT_KEY 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'FIND_STRUCT_KEY 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE FIND_STRUCT_KEY (KEY U DFLT)
    (COND ((NULL U) (MKQUOTE DFLT))
          ((EQ (CAR U) KEY) (COND ((NULL (CDR U)) NIL) (T (CADR U))))
          (T (FIND_STRUCT_KEY KEY (CDDR U) DFLT)))) 
(PUT 'DEFSTRUCTVECTOR 'NUMBER-OF-ARGS 1) 
(PUT 'DEFSTRUCTVECTOR 'DEFINED-ON-LINE '188) 
(PUT 'DEFSTRUCTVECTOR 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'DEFSTRUCTVECTOR 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE DEFSTRUCTVECTOR (L)
    (PROG (I V)
      (SETQ I 0)
      (SETQ V (MKVECT (SUB1 (LENGTH L))))
      (SETQ I 0)
      (PROG (VL)
        (SETQ VL L)
       LAB
        (COND ((NULL VL) (RETURN NIL)))
        ((LAMBDA (VL) (PROGN (PUTV V I VL) (SETQ I (PLUS I 1)))) (CAR VL))
        (SETQ VL (CDR VL))
        (GO LAB))
      (RETURN V))) 
(PUT 'BUILD_DEFSTRUCT_PREDICATE_FUNCTION 'NUMBER-OF-ARGS 2) 
(PUT 'BUILD_DEFSTRUCT_PREDICATE_FUNCTION 'DEFINED-ON-LINE '198) 
(PUT 'BUILD_DEFSTRUCT_PREDICATE_FUNCTION 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'BUILD_DEFSTRUCT_PREDICATE_FUNCTION 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE BUILD_DEFSTRUCT_PREDICATE_FUNCTION (NAME FNNAME)
    (LIST 'DE FNNAME '(X)
          (LIST 'AND '(VECTORP X) (LIST 'EQ (MKQUOTE NAME) '(IGETV X 0))))) 
(PUT 'BUILD_DEFSTRUCT_ACCESSOR_MACRO 'NUMBER-OF-ARGS 2) 
(PUT 'BUILD_DEFSTRUCT_ACCESSOR_MACRO 'DEFINED-ON-LINE '204) 
(PUT 'BUILD_DEFSTRUCT_ACCESSOR_MACRO 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'BUILD_DEFSTRUCT_ACCESSOR_MACRO 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE BUILD_DEFSTRUCT_ACCESSOR_MACRO (SLOT_NAME INDX)
    (LIST 'DM SLOT_NAME '(U) (LIST 'LIST ''STRUCTFETCH '(CADR U) INDX))) 
(PUT 'STRUCTFETCH 'DEFINED-ON-LINE '207) 
(PUT 'STRUCTFETCH 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'STRUCTFETCH 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DM STRUCTFETCH (U)
    (COND (*FASTSTRUCTS (CONS 'IGETV (CDR U))) (T (CONS 'GETV (CDR U))))) 
(PUT 'RSETF 'DEFINED-ON-LINE '215) 
(PUT 'RSETF 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'RSETF 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DM RSETF (U) (EXPANDRSETF (CADR U) (CADDR U))) 
(PUT 'EXPANDRSETF 'NUMBER-OF-ARGS 2) 
(PUT 'EXPANDRSETF 'DEFINED-ON-LINE '217) 
(PUT 'EXPANDRSETF 'DEFINED-IN-FILE 'RLISP88/MSTRUCT.RED) 
(PUT 'EXPANDRSETF 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE EXPANDRSETF (LHS RHS)
    (COND ((ATOM LHS) (LIST 'SETQ LHS RHS))
          ((EQCAR LHS '&VARIABLE_FETCH)
           (CONS '&VARIABLE_STORE (APPEND (CDR LHS) (LIST RHS))))
          ((GET (CAR LHS) 'ASSIGN_OP)
           (CONS (GET (CAR LHS) 'ASSIGN_OP) (APPEND (CDR LHS) (LIST RHS))))
          ((AND (GETD (CAR LHS)) (EQCAR (GETD (CAR LHS)) 'MACRO))
           (EXPANDRSETF (APPLY (CDR (GETD (CAR LHS))) (LIST LHS)) RHS))
          (T (ERROR 0 (LIST LHS "bad RSETF form"))))) 
(DEFLIST '((GETV PUTV) (IGETV PUTV) (CAR RPLACA) (CDR RPLACD)) 'ASSIGN_OP) 
(PUT 'QGETV 'ASSIGN_OP 'QPUTV) 
(ENDMODULE) 