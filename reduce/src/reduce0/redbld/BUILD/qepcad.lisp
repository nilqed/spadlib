(cl:declaim (cl:optimize cl:debug cl:safety))
(cl:declaim (sb-ext:muffle-conditions sb-ext:compiler-note cl:style-warning))
(MODULE (LIST 'QEPCAD)) 
(REVISION 'QEPCAD "$Id: qepcad.red 6174 2021-11-15 15:53:14Z thomas-sturm $") 
(COPYRIGHT 'QEPCAD "(c) 1995-2009 A. Dolzmann and T. Sturm, 2010-2017 T. Sturm") 
(FLUID '(*RLVERBOSE)) 
(FLUID '(*ECHO)) 
(FLUID '(*TIME)) 
(FLUID '(*BACKTRACE)) 
(FLUID '(*NAT)) 
(FLUID '(*FANCY)) 
(FLUID '(*OUTPUTHANDLER)) 
(GLOBAL '(QEPCAD_QEPCAD*)) 
(GLOBAL '(QEPCAD_SLFQ*)) 
(GLOBAL '(QEPCAD_TMPDIR*)) 
(GLOBAL '(QEPCAD_AWK*)) 
(SETQ QEPCAD_QEPCAD* "qepcad") 
(SETQ QEPCAD_SLFQ* "slfq") 
(SETQ QEPCAD_TMPDIR* "/tmp/") 
(SETQ QEPCAD_AWK*
        (LTO_SCONCAT (LIST (SYSTO_GET-RESOURCE-DIRECTORY) "/" "qepcad.awk"))) 
(SWITCH (LIST 'RLQEFBQEPCAD)) 
(SWITCH (LIST 'RLQEFBSLFQ)) 
(SWITCH (LIST 'RLSLFQVB)) 
(ON1 'RLQEFBSLFQ) 
(RL_PROVIDESERVICE 'RL_QEPCAD 'QEPCAD_QEPCAD NIL) 
(PUT 'QEPCAD_QEPCAD 'NUMBER-OF-ARGS 3) 
(DE QEPCAD_QEPCAD (F N L)
    (QEPCAD_GENERIC F (LIST N L) "qepcad" 'QEPCAD_PRINTER 'QEPCAD_RUN)) 
(RL_PROVIDESERVICE 'RL_SLFQ 'QEPCAD_SLFQ NIL) 
(PUT 'QEPCAD_SLFQ 'NUMBER-OF-ARGS 3) 
(DE QEPCAD_SLFQ (F N L)
    (QEPCAD_GENERIC F (LIST N L) "slfq"
     (FUNCTION (LAMBDA (X) (MATHPRINT (RL_PREPFOF X)))) 'QEPCAD_RUNSLFQ)) 
(PUT 'QEPCAD_GENERIC 'NUMBER-OF-ARGS 5) 
(DE QEPCAD_GENERIC (F ARGL STEM PRINTER RUNNER)
    (PROG (FN1 FN2 FN3 RESULT)
      (PROG (G663 G664)
        (SETQ G663 (QEPCAD_FN STEM))
        (SETQ G664 G663)
        (SETQ FN1 (CAR G663))
        (SETQ G663 (CDR G663))
        (SETQ FN2 (CAR G663))
        (SETQ G663 (CDR G663))
        (SETQ FN3 (CAR G663))
        (SETQ G663 (CDR G663))
        (RETURN G664))
      (QEPCAD_DUMP F FN1 PRINTER)
      (APPLY RUNNER (APPEND ARGL (LIST FN1 FN2 FN3)))
      (SETQ RESULT (QEPCAD_READRESULT FN2))
      (QEPCAD_REGISTEREXTERNALTIME FN3)
      (SYSTEM (LTO_SCONCAT (LIST "rm -f " FN1 " " FN2 " " FN3)))
      (COND ((NULL RESULT) (LPRIM "external computation failed")))
      (RETURN (OR (RL_SIMP RESULT) F)))) 
(PUT 'QEPCAD_FN 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_FN (STEM)
    (PROG (BNAME)
      (SETQ BNAME
              (LTO_SCONCAT
               (LIST QEPCAD_TMPDIR* "rl" STEM "-"
                     (OR (GETENV "USER") "unknown") "-" (LTO_AT2STR (GETPID))
                     "-" (LTO_AT2STR (RANDOM (EXPT 10 8))))))
      (RETURN
       (LIST (LTO_SCONCAT (LIST BNAME "." STEM))
             (LTO_SCONCAT (LIST BNAME ".red"))
             (LTO_SCONCAT (LIST BNAME ".time")))))) 
(PUT 'QEPCAD_DUMP 'NUMBER-OF-ARGS 3) 
(DE QEPCAD_DUMP (F FN PRINTER)
    (PROG (W)
      (COND ((EQUAL FN "") (PROGN (APPLY PRINTER (LIST F)) (RETURN NIL))))
      (COND (*RLVERBOSE (IOTO_TPRIN2 (LIST "+++ creating " FN " ... "))))
      (OUT (LIST FN))
      (SETQ W (ERRORSET (LIST PRINTER (MKQUOTE F)) T *BACKTRACE))
      (SHUT (LIST FN))
      (COND
       ((ERRORP W)
        (REDERR (LIST "qepcad_dump: problem dumping" F "using" PRINTER))))
      (COND (*RLVERBOSE (IOTO_PRIN2T "done"))))) 
(PUT 'QEPCAD_PRINTER 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_PRINTER (F)
    (PROG (FF FL BL L SAVE_LINELENGTH)
      (SETQ FF (SETQ F (CL_PNF F)))
      (PROG ()
       WHILELABEL
        (COND
         ((NOT
           ((LAMBDA (X) (OR (EQ X 'EX) (EQ X 'ALL)))
            (COND ((ATOM FF) FF) (T (CAR FF)))))
          (RETURN NIL)))
        (PROGN
         (PROG (W1) (SETQ W1 (CADR FF)) (SETQ BL (CONS W1 BL)) (RETURN W1))
         (SETQ FF (CADDR FF)))
        (GO WHILELABEL))
      (SETQ BL (REVERSIP BL))
      (SETQ FL (CL_FVARL1 F))
      (SETQ L (APPEND FL BL))
      (SETQ SAVE_LINELENGTH (LINELENGTH (EXPT 2 26)))
      (PRIN2T "[Qepcad B input, automatically generated in Reduce/Redlog")
      (PRIN2T
       (LTO_SCONCAT
        (LIST " by " (OR (GETENV "USER") "unknown") " on " (DATE))))
      (PRIN2T " http://reduce-algebra.sourceforge.net/")
      (PRIN2T " http://www.redlog.eu/]")
      (PRIN2 "(")
      (PRIN2 (CAR L))
      (PROG (X)
        (SETQ X (CDR L))
       LAB
        (COND ((NULL X) (RETURN NIL)))
        ((LAMBDA (X) (PROGN (PRIN2 ",") (PRIN2 X))) (CAR X))
        (SETQ X (CDR X))
        (GO LAB))
      (PRIN2T ")")
      (PRIN2T (LENGTH FL))
      (QEPCAD_PRINT F)
      (PRIN2T ".")
      (PRIN2T "finish")
      (LINELENGTH SAVE_LINELENGTH))) 
(PUT 'QEPCAD_PRINT 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_PRINT (F)
    (PROG (W SVFANCY SVPPRIFN SVPRTCH)
      (SETQ SVFANCY *FANCY)
      (SETQ SVPPRIFN (GET 'TIMES 'PPRIFN))
      (SETQ SVPRTCH (GET 'EXPT 'PRTCH))
      (COND (SVFANCY (OFF1 'FANCY)))
      (PUT 'TIMES 'PPRIFN 'QEPCAD_PPRICADTIMES)
      (PUT 'EXPT 'PRTCH '^)
      (SETQ W (ERRORSET (LIST 'QEPCAD_CADPRINT1 (MKQUOTE F)) T *BACKTRACE))
      (COND (SVFANCY (ON1 'FANCY)))
      (PUT 'TIMES 'PPRIFN SVPPRIFN)
      (PUT 'EXPT 'PRTCH SVPRTCH)
      (COND ((ERRORP W) (REDERR (LIST "qepcad_print: could not print" F))))
      (RETURN (CAR W)))) 
(PUT 'QEPCAD_CADPRINT1 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_CADPRINT1 (F)
    (PROG (*NAT)
      (TERPRI* NIL)
      (PROG ()
       WHILELABEL
        (COND
         ((NOT (MEMQ (COND ((ATOM F) F) (T (CAR F))) '(EX ALL))) (RETURN NIL)))
        (PROGN
         (PRIN2* "(")
         (PRIN2* (COND ((EQ (COND ((ATOM F) F) (T (CAR F))) 'EX) "E") (T "A")))
         (PRIN2* (CADR F))
         (PRIN2* ") ")
         (SETQ F (CADDR F)))
        (GO WHILELABEL))
      (PRIN2* "[")
      (QEPCAD_CADPRINT2 F)
      (PRIN2* "]")
      (TERPRI* NIL))) 
(PUT 'QEPCAD_CADPRINT2 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_CADPRINT2 (F)
    (PROG (OP ARGL OUTPUTHANDLER*)
      (SETQ OP (COND ((ATOM F) F) (T (CAR F))))
      (COND
       ((OR (OR (EQ OP 'TRUE) (EQ OP 'FALSE))
            (OR (OR (OR (EQ OP 'OR) (EQ OP 'AND)) (EQ OP 'NOT))
                (OR (EQ OP 'IMPL) (EQ OP 'REPL) (EQ OP 'EQUIV)))
            (OR (EQ OP 'EX) (EQ OP 'ALL)) (OR (EQ OP 'BEX) (EQ OP 'BALL)))
        (PROGN
         (COND
          ((OR (EQ OP 'TRUE) (EQ OP 'FALSE))
           (PROGN (QEPCAD_CADPRINTTVAL F) (RETURN NIL))))
         (PRIN2* "[")
         (SETQ ARGL (CDR F))
         (QEPCAD_CADPRINT2 (CAR ARGL))
         (PROG (X)
           (SETQ X (CDR ARGL))
          LAB
           (COND ((NULL X) (RETURN NIL)))
           ((LAMBDA (X) (PROGN (QEPCAD_CADPRINTREL OP) (QEPCAD_CADPRINT2 X)))
            (CAR X))
           (SETQ X (CDR X))
           (GO LAB))
         (PRIN2* "]")
         (RETURN NIL))))
      (MAPRIN (PREPF (CADR F)))
      (QEPCAD_CADPRINTREL OP)
      (PRIN2* "0"))) 
(PUT 'QEPCAD_CADPRINTTVAL 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_CADPRINTTVAL (TV)
    (COND
     ((EQ TV 'TRUE)
      (PROGN (PRIN2* "0") (QEPCAD_CADPRINTREL 'EQUAL) (PRIN2* "0")))
     (T
      (PROGN
       (COND (NIL NIL))
       (PRIN2* "0")
       (QEPCAD_CADPRINTREL 'NEQ)
       (PRIN2* "0"))))) 
(PUT 'QEPCAD_CADPRINTREL 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_CADPRINTREL (OP)
    (PROGN
     (PRIN2* " ")
     (PRIN2*
      (COND ((EQ OP 'EQUAL) "=") ((EQ OP 'NEQ) "/=") ((EQ OP 'LESSP) "<")
            ((EQ OP 'GREATERP) ">") ((EQ OP 'LEQ) "<=") ((EQ OP 'GEQ) ">=")
            ((EQ OP 'OR) "\\/") ((EQ OP 'AND) "/\\") ((EQ OP 'IMPL) "==>")
            ((EQ OP 'EQUIV) "<==>")))
     (PRIN2* " "))) 
(PUT 'QEPCAD_PPRICADTIMES 'NUMBER-OF-ARGS 2) 
(DE QEPCAD_PPRICADTIMES (F N)
    (PROG (W OUTPUTHANDLER*)
      (SETQ W (LESSP (GET (CAR F) 'INFIX) N))
      (COND (W (PRIN2* "(")))
      (MAPRIN (CADR F))
      (PROG (X)
        (SETQ X (CDDR F))
       LAB
        (COND ((NULL X) (RETURN NIL)))
        ((LAMBDA (X) (PROGN (PRIN2* " ") (MAPRIN X))) (CAR X))
        (SETQ X (CDR X))
        (GO LAB))
      (COND (W (PRIN2* ")"))))) 
(PUT 'QEPCAD_RUN 'NUMBER-OF-ARGS 5) 
(DE QEPCAD_RUN (N L FN1 FN2 FN3)
    (PROG (NARG LARG CALL VB TM)
      (SETQ NARG
              (LTO_SCONCAT (LIST "+N" (LTO_AT2STR (TIMES N (EXPT 10 6))) " ")))
      (SETQ LARG
              (LTO_SCONCAT (LIST "+L" (LTO_AT2STR (TIMES L (EXPT 10 3))) " ")))
      (SETQ VB (LTO_AT2STR *RLVERBOSE))
      (SETQ CALL
              (LTO_SCONCAT
               (LIST QEPCAD_QEPCAD* " " NARG LARG "< " FN1 " | awk -v rf=" FN2
                     " -v tf=" FN3 " -v verb=" VB
                     " -v slfqvb=nil -v name=QEPCAD -f " QEPCAD_AWK*)))
      (COND
       (*RLVERBOSE (IOTO_TPRIN2T (LTO_SCONCAT (LIST "+++ calling " CALL)))))
      (SYSTEM CALL))) 
(PUT 'QEPCAD_RUNSLFQ 'NUMBER-OF-ARGS 5) 
(DE QEPCAD_RUNSLFQ (N L FN1 FN2 FN3)
    (PROG (NARG LARG CALL VB TM SVB)
      (SETQ NARG (LTO_SCONCAT (LIST "-N " (LTO_AT2STR N) " ")))
      (SETQ LARG
              (LTO_SCONCAT
               (LIST "-P " (LTO_AT2STR (TIMES L (EXPT 10 3))) " ")))
      (SETQ VB (LTO_AT2STR *RLVERBOSE))
      (SETQ SVB (LTO_AT2STR *RLSLFQVB))
      (SETQ CALL
              (LTO_SCONCAT
               (LIST QEPCAD_SLFQ* " " NARG LARG "< " FN1
                     " 2> /dev/null | awk -v rf=" FN2 " -v tf=" FN3 " -v verb="
                     VB " -v slfqvb=" SVB " -v name=SLFQ -f " QEPCAD_AWK*)))
      (COND
       (*RLVERBOSE (IOTO_TPRIN2T (LTO_SCONCAT (LIST "+++ calling " CALL)))))
      (SYSTEM CALL))) 
(PUT 'QEPCAD_READRESULT 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_READRESULT (FN)
    (PROG (SVECHO SVSEMIC FH W)
      (SETQ SVSEMIC SEMIC*)
      (SETQ SVECHO *ECHO)
      (SETQ *ECHO NIL)
      (SETQ FH (RDS (OPEN FN 'INPUT)))
      (SETQ W (ERRORSET (LIST 'XREAD T) NIL *BACKTRACE))
      (CLOSE (RDS FH))
      (SETQ SEMIC* SVSEMIC)
      (SETQ *ECHO SVECHO)
      (COND
       ((ERRORP W)
        (REDERR (LIST "qepcad_readResult: bad formula in file" FN))))
      (RETURN (CAR W)))) 
(PUT 'QEPCAD_REGISTEREXTERNALTIME 'NUMBER-OF-ARGS 1) 
(DE QEPCAD_REGISTEREXTERNALTIME (FN)
    (PROG (FH SVECHO)
      (SETQ SVECHO *ECHO)
      (SETQ *ECHO NIL)
      (SETQ FH (RDS (OPEN FN 'INPUT)))
      (RL_REGISTEREXTERNALTIME (READ))
      (CLOSE (RDS FH))
      (SETQ *ECHO SVECHO))) 
(ENDMODULE) 