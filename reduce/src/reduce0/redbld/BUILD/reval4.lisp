(cl:declaim (cl:optimize cl:debug cl:safety))
(cl:declaim (sb-ext:muffle-conditions sb-ext:compiler-note cl:style-warning))
(MODULE (LIST 'REVAL4)) 
(PUT 'TYPE 'NUMBER-OF-ARGS 1) 
(PUT 'TYPE 'DEFINED-ON-LINE '32) 
(PUT 'TYPE 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'TYPE 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE TYPE (U) (CAR U)) 
(PUT 'VALUE 'NUMBER-OF-ARGS 1) 
(PUT 'VALUE 'DEFINED-ON-LINE '36) 
(PUT 'VALUE 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'VALUE 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE VALUE (U) (CADR U)) 
(PUT 'MKNOVALOBJ 'NUMBER-OF-ARGS 0) 
(PUT 'MKNOVALOBJ 'DEFINED-ON-LINE '38) 
(PUT 'MKNOVALOBJ 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'MKNOVALOBJ 'PROCEDURE_TYPE '(ARROW UNIT GENERAL)) 
(DE MKNOVALOBJ NIL (MKOBJECT NIL 'NOVAL)) 
(PUT 'GETOBJECT 'NUMBER-OF-ARGS 1) 
(PUT 'GETOBJECT 'DEFINED-ON-LINE '40) 
(PUT 'GETOBJECT 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'GETOBJECT 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE GETOBJECT (U)
    ((LAMBDA (X)
       (COND ((AND X (EQ (TYPE X) 'GENERIC)) (N_FORM (PRINT (VALUE X))))
             (T X)))
     (GET U 'AVALUE))) 
(PUT 'PUTOBJECT 'NUMBER-OF-ARGS 3) 
(PUT 'PUTOBJECT 'DEFINED-ON-LINE '44) 
(PUT 'PUTOBJECT 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'PUTOBJECT 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE PUTOBJECT (U V W) (PUT U 'AVALUE (MKOBJECT V W))) 
(PUT 'XTYPE 'NUMBER-OF-ARGS 2) 
(PUT 'XTYPE 'DEFINED-ON-LINE '50) 
(PUT 'XTYPE 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'XTYPE 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE XTYPE (U V) (XTYPE1 (TYPE U) V)) 
(PUT 'XTYPE1 'NUMBER-OF-ARGS 2) 
(PUT 'XTYPE1 'DEFINED-ON-LINE '54) 
(PUT 'XTYPE1 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'XTYPE1 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE XTYPE1 (U V)
    (COND ((NULL (TYPE_IN_PCKGP U)) NIL)
          (T (OR (EQ U V) (XTYPELIST (GET U 'UPTREE) V))))) 
(PUT 'XTYPELIST 'NUMBER-OF-ARGS 2) 
(PUT 'XTYPELIST 'DEFINED-ON-LINE '58) 
(PUT 'XTYPELIST 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'XTYPELIST 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE XTYPELIST (U V) (AND U (OR (XTYPE1 (CAR U) V) (XTYPELIST (CDR U) V)))) 
(PUT 'RAPPLY 'NUMBER-OF-ARGS 2) 
(PUT 'RAPPLY 'DEFINED-ON-LINE '61) 
(PUT 'RAPPLY 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'RAPPLY 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE RAPPLY (U V) (RAPPLY1 U V)) 
(PUT 'RAPPLY1 'NUMBER-OF-ARGS 2) 
(PUT 'RAPPLY1 'DEFINED-ON-LINE '66) 
(PUT 'RAPPLY1 'DEFINED-IN-FILE 'REDUCE4/REVAL4.RED) 
(PUT 'RAPPLY1 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE RAPPLY1 (U V)
    (PROG (X Y)
      (COND
       ((AND (SETQ X (GETOBJECT U)) (SETQ Y (GET (TYPE X) 'GETFN)))
        (RETURN (TYPE_REDUCE1 (APPLY2 Y X V)))))
      (SETQ X
              (PROG (J FORALL-RESULT FORALL-ENDPTR)
                (SETQ J V)
                (COND ((NULL J) (RETURN NIL)))
                (SETQ FORALL-RESULT
                        (SETQ FORALL-ENDPTR
                                (CONS ((LAMBDA (J) (TYPE J)) (CAR J)) NIL)))
               LOOPLABEL
                (SETQ J (CDR J))
                (COND ((NULL J) (RETURN FORALL-RESULT)))
                (RPLACD FORALL-ENDPTR
                        (CONS ((LAMBDA (J) (TYPE J)) (CAR J)) NIL))
                (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
                (GO LOOPLABEL)))
      (SETQ Y (TYPE_FUNCTION U X V))
      (COND
       ((NULL Y)
        (COND ((FLAGP U 'OPR) (SETQ U (EVAL_GENERIC U V)))
              ((NULL (CDR X)) (REDERR (LIST U "not defined for type" (CAR X))))
              (T (REDERR (CONS U (CONS "not defined for types" X))))))
       (T (SETQ U (APPLY (CAR Y) V))))
      (SETQ U (TYPE_REDUCE1 U))
      (COND ((NULL *REDUCE4) (RETURN (VALUE U))) (T (RETURN U))))) 
(ENDMODULE) 