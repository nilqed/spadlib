(cl:declaim (cl:optimize cl:debug cl:safety))
(cl:declaim (sb-ext:muffle-conditions sb-ext:compiler-note cl:style-warning))
(MODULE (LIST 'BACKTRCK)) 
(FLUID '(G_SKIP_TO_LEVEL)) 
(PUT 'GENERATE_NEXT_CHOICE 'NUMBER-OF-ARGS 3) 
(PUT 'GENERATE_NEXT_CHOICE 'DEFINED-ON-LINE '30) 
(PUT 'GENERATE_NEXT_CHOICE 'DEFINED-IN-FILE 'ASSIST/BACKTRCK.RED) 
(PUT 'GENERATE_NEXT_CHOICE 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE GENERATE_NEXT_CHOICE (SC PARTIAL_PERM CANON)
    (PROG (NEXT_PERM COMPARISON EXTENSIONS N_POINTS LEN NEXT_IMG)
      (SETQ N_POINTS 0)
      (SETQ LEN 0)
      (SETQ NEXT_IMG 0)
      (SETQ N_POINTS (UPBVE (CAR SC)))
      (SETQ G_SKIP_TO_LEVEL (SETQ LEN (PLUS (UPBVE PARTIAL_PERM) 1)))
      (SETQ NEXT_IMG 1)
      (SC_SETBASE SC PARTIAL_PERM)
      (PROG ()
       REPEATLABEL
        (PROGN
         (SETQ EXTENSIONS (CANDIDATE_EXTENSIONS SC PARTIAL_PERM))
         (COND
          ((MEMBER NEXT_IMG EXTENSIONS)
           (PROGN
            (SETQ NEXT_PERM (VECTAPPEND1 PARTIAL_PERM NEXT_IMG))
            (COND
             ((ACCEPTABLE NEXT_PERM)
              (PROGN
               (ASSIGN NEXT_PERM)
               (SETQ COMPARISON (COMPARE NEXT_PERM CANON))
               (COND
                ((EQUAL COMPARISON 0)
                 (PROGN
                  (COND
                   ((LESSP LEN N_POINTS)
                    (SETQ CANON
                            (CAR (GENERATE_NEXT_CHOICE SC NEXT_PERM CANON))))
                   (CANON
                    (PROCESS_NEW_AUTOMORPHISM SC
                     (PE_MULT (PE_INV CANON) NEXT_PERM))))
                  NIL))
                ((EQUAL COMPARISON 1)
                 (COND
                  ((LESSP LEN N_POINTS)
                   (SETQ CANON
                           (CAR (GENERATE_NEXT_CHOICE SC NEXT_PERM CANON))))
                  (T (SETQ CANON (COPY NEXT_PERM))))))
               (DEASSIGN NEXT_PERM)))))))
         (SETQ NEXT_IMG (PLUS NEXT_IMG 1)))
        (COND
         ((NOT
           (OR (GREATERP NEXT_IMG N_POINTS) (GREATERP LEN G_SKIP_TO_LEVEL)))
          (GO REPEATLABEL))))
      (RETURN (CONS CANON SC)))) 
(PUT 'CANDIDATE_EXTENSIONS 'NUMBER-OF-ARGS 2) 
(PUT 'CANDIDATE_EXTENSIONS 'DEFINED-ON-LINE '71) 
(PUT 'CANDIDATE_EXTENSIONS 'DEFINED-IN-FILE 'ASSIST/BACKTRCK.RED) 
(PUT 'CANDIDATE_EXTENSIONS 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE CANDIDATE_EXTENSIONS (SC PARTIAL_PERM)
    (PROG (EXTENSIONS)
      (COND
       ((NULL (GETV (CDR SC) (DIFFERENCE (PLUS (UPBVE PARTIAL_PERM) 1) 1)))
        (SETQ EXTENSIONS
                (PROG (COUNT FORALL-RESULT FORALL-ENDPTR)
                  (SETQ COUNT 1)
                  (COND
                   ((MINUSP (DIFFERENCE (UPBVE (CAR SC)) COUNT)) (RETURN NIL)))
                  (SETQ FORALL-RESULT (SETQ FORALL-ENDPTR (CONS COUNT NIL)))
                 LOOPLABEL
                  (SETQ COUNT (PLUS2 COUNT 1))
                  (COND
                   ((MINUSP (DIFFERENCE (UPBVE (CAR SC)) COUNT))
                    (RETURN FORALL-RESULT)))
                  (RPLACD FORALL-ENDPTR (CONS COUNT NIL))
                  (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
                  (GO LOOPLABEL))))
       (T
        (SETQ EXTENSIONS
                (GETV
                 (GETV (CDR SC) (DIFFERENCE (PLUS (UPBVE PARTIAL_PERM) 1) 1))
                 (DIFFERENCE 5 1)))))
      (PROG (COUNT)
        (SETQ COUNT 1)
       LAB
        (COND ((MINUSP (DIFFERENCE (UPBVE PARTIAL_PERM) COUNT)) (RETURN NIL)))
        (SETQ EXTENSIONS
                (DELETE (GETV PARTIAL_PERM (DIFFERENCE COUNT 1)) EXTENSIONS))
        (SETQ COUNT (PLUS2 COUNT 1))
        (GO LAB))
      (RETURN EXTENSIONS))) 
(PUT 'PROCESS_NEW_AUTOMORPHISM 'NUMBER-OF-ARGS 2) 
(PUT 'PROCESS_NEW_AUTOMORPHISM 'DEFINED-ON-LINE '85) 
(PUT 'PROCESS_NEW_AUTOMORPHISM 'DEFINED-IN-FILE 'ASSIST/BACKTRCK.RED) 
(PUT 'PROCESS_NEW_AUTOMORPHISM 'PROCEDURE_TYPE
     '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE PROCESS_NEW_AUTOMORPHISM (SC NEW_AUT)
    (PROG (INV_NEW_AUT SD COUNT)
      (SETQ COUNT 0)
      (SETQ INV_NEW_AUT (PE_INV NEW_AUT))
      (SETQ COUNT 0)
      (PROG ()
       REPEATLABEL
        (PROGN
         (SETQ COUNT (PLUS COUNT 1))
         (SETQ SD (GETV (CDR SC) (DIFFERENCE COUNT 1)))
         (COND
          ((NULL SD)
           (SETQ SD
                   (SD_CREATE (UPBVE (CAR SC))
                    (GETV (CAR SC) (DIFFERENCE COUNT 1))))))
         (SD_ADDGEN SD NEW_AUT INV_NEW_AUT)
         (PUTV (CDR SC) (DIFFERENCE COUNT 1) SD))
        (COND
         ((NOT
           (NEQ
            (GETV NEW_AUT (DIFFERENCE (GETV (CAR SC) (DIFFERENCE COUNT 1)) 1))
            (GETV (CAR SC) (DIFFERENCE COUNT 1))))
          (GO REPEATLABEL))))
      (SETQ G_SKIP_TO_LEVEL COUNT))) 
(PUT 'CANON_ORDER 'NUMBER-OF-ARGS 1) 
(PUT 'CANON_ORDER 'DEFINED-ON-LINE '105) 
(PUT 'CANON_ORDER 'DEFINED-IN-FILE 'ASSIST/BACKTRCK.RED) 
(PUT 'CANON_ORDER 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE CANON_ORDER (N)
    (PROG (AUT_SC)
      (SETQ AUT_SC (SC_CREATE N))
      (RETURN (GENERATE_NEXT_CHOICE AUT_SC (MKVECT (DIFFERENCE 0 1)) NIL)))) 
(ENDMODULE) 