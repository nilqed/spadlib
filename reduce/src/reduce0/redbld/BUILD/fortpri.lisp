(cl:declaim (cl:optimize cl:debug cl:safety))
(cl:declaim (sb-ext:muffle-conditions sb-ext:compiler-note cl:style-warning))
(MODULE (LIST 'FORTPRI)) 
(FLUID
 '(*FORT *FORTUPPER *PERIOD SCOUNTR EXPLIS FBRKT FVAR NCHARS SVAR POSN*
   FORTLANG*)) 
(FLUID '(PREVIOUS-FANCY-STATE *FANCY)) 
(PUT 'FORT 'SIMPFG '((T (SAVE-FANCY)) (NIL (RESTORE-FANCY)))) 
(PUT 'SAVE-FANCY 'NUMBER-OF-ARGS 0) 
(PUT 'SAVE-FANCY 'DEFINED-ON-LINE '51) 
(PUT 'SAVE-FANCY 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'SAVE-FANCY 'PROCEDURE_TYPE '(ARROW UNIT GENERAL)) 
(DE SAVE-FANCY NIL
    (PROG ()
      (SETQ PREVIOUS-FANCY-STATE *FANCY)
      (COND (*FANCY (OFF (LIST 'FANCY)))))) 
(PUT 'RESTORE-FANCY 'NUMBER-OF-ARGS 0) 
(PUT 'RESTORE-FANCY 'DEFINED-ON-LINE '57) 
(PUT 'RESTORE-FANCY 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'RESTORE-FANCY 'PROCEDURE_TYPE '(ARROW UNIT GENERAL)) 
(DE RESTORE-FANCY NIL (COND (PREVIOUS-FANCY-STATE (ON (LIST 'FANCY))))) 
(SWITCH (LIST 'FORTUPPER)) 
(GLOBAL '(CARD_NO CHARASSOC* FORT_WIDTH FORT_LANG SPARE* VARNAM*)) 
(SETQ CARD_NO 20) 
(SETQ CHARASSOC*
        '((|a| . A) (|b| . B) (|c| . C) (|d| . D) (|e| . E) (|f| . F) (|g| . G)
          (|h| . H) (|i| . I) (|j| . J) (|k| . K) (|l| . L) (|m| . M) (|n| . N)
          (|o| . O) (|p| . P) (|q| . Q) (|r| . R) (|s| . S) (|t| . T) (|u| . U)
          (|v| . V) (|w| . W) (|x| . X) (|y| . Y) (|z| . Z))) 
(SETQ FORT_WIDTH 70) 
(SETQ POSN* 0) 
(SETQ VARNAM* 'ANS) 
(SETQ FORT_LANG 'FORT) 
(FLAG '(CARD_NO FORT_WIDTH FORT_LANG) 'SHARE) 
(PUT 'FORT_ARRAY 'STAT 'RLIS) 
(FLAG '(FORT_ARRAY) 'FLAGOP) 
(PUT 'VARNAME 'NUMBER-OF-ARGS 1) 
(PUT 'VARNAME 'DEFINED-ON-LINE '93) 
(PUT 'VARNAME 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'VARNAME 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE VARNAME (U)
    (COND ((NOT (IDP (CAR U))) (TYPERR (CAR U) "identifier"))
          (T (SETQ VARNAM* (CAR U))))) 
(RLISTAT '(VARNAME)) 
(PUT 'FLENGTH 'NUMBER-OF-ARGS 2) 
(PUT 'FLENGTH 'DEFINED-ON-LINE '100) 
(PUT 'FLENGTH 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FLENGTH 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FLENGTH (U CHARS)
    (COND ((LESSP CHARS 0) CHARS)
          ((ATOM U)
           (DIFFERENCE CHARS
                       (COND
                        ((NUMBERP U)
                         (COND ((FIXP U) (PLUS (FLATSIZEC U) 1))
                               (T (FLATSIZEC U))))
                        (T
                         (FLATSIZEC
                          ((LAMBDA (X) (COND (X X) (T U))) (GET U 'PRTCH)))))))
          (T (FLENGTH (CAR U) (DIFFERENCE (FLENLIS (CDR U) CHARS) 2))))) 
(PUT 'FLENLIS 'NUMBER-OF-ARGS 2) 
(PUT 'FLENLIS 'DEFINED-ON-LINE '109) 
(PUT 'FLENLIS 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FLENLIS 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FLENLIS (U CHARS)
    (COND ((NULL U) CHARS) ((LESSP CHARS 0) CHARS) ((ATOM U) (FLENGTH U CHARS))
          (T (FLENLIS (CDR U) (FLENGTH (CAR U) CHARS))))) 
(PUT 'FMPRINT 'NUMBER-OF-ARGS 2) 
(PUT 'FMPRINT 'DEFINED-ON-LINE '115) 
(PUT 'FMPRINT 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FMPRINT 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FMPRINT (L P)
    (PROG (X W)
      (COND ((NULL L) (RETURN NIL))
            ((ATOM L)
             (PROGN
              (COND ((EQ L 'E) (RETURN (FPRIN2* "EXP(1.0)"))))
              (COND ((AND (FIXP L) *PERIOD) (RETURN (FMPRINT (I2RD* L) P))))
              (COND
               ((OR (NOT (NUMBERP L)) (NOT (LESSP L 0))) (RETURN (FPRIN2* L))))
              (FPRIN2* "(")
              (SETQ FBRKT (CONS NIL FBRKT))
              (FPRIN2* L)
              (FPRIN2* ")")
              (RETURN (SETQ FBRKT (CDR FBRKT)))))
            ((STRINGP L) (RETURN (FPRIN2* L)))
            ((NOT (ATOM (CAR L))) (FMPRINT (CAR L) P))
            ((SETQ X (GET (CAR L) 'FORT)) (RETURN (APPLY2 X L P)))
            ((OR
              (AND (SETQ X (GET (CAR L) 'PPRIFN))
                   (NOT (EQ (SETQ X (APPLY2 X L P)) 'FAILED)))
              (AND (SETQ X (GET (CAR L) 'PRIFN))
                   (NOT (EQ (SETQ X (APPLY1 X L)) 'FAILED))))
             (RETURN X))
            ((SETQ X (GET (CAR L) 'INFIX))
             (PROGN
              (SETQ P (NOT (GREATERP X P)))
              (COND (P (PROGN (FPRIN2* "(") (SETQ FBRKT (CONS NIL FBRKT)))))
              (FNPRINT (CAR L) X (CDR L))
              (COND (P (PROGN (FPRIN2* ")") (SETQ FBRKT (CDR FBRKT)))))
              (RETURN NIL)))
            (T (FPRIN2* (CAR L))))
      (SETQ W (AND (EQUAL FORTLANG* 'C) (FLAGP (CAR L) 'FORT_ARRAY)))
      (FPRIN2* (COND (W "[") (T "(")))
      (SETQ FBRKT (CONS NIL FBRKT))
      (SETQ X *PERIOD)
      (COND
       ((OR (NEQ (GETTYPE (CAR L)) 'OPERATOR) (FLAGP (CAR L) 'FORT_ARRAY))
        (SETQ *PERIOD NIL)))
      (COND ((CDR L) (FNPRINT (COND (W "][") (T '*COMMA*)) 0 (CDR L))))
      (SETQ *PERIOD X)
      (FPRIN2* (COND (W "]") (T ")")))
      (RETURN (SETQ FBRKT (CDR FBRKT))))) 
(PUT 'FNPRINT 'NUMBER-OF-ARGS 3) 
(PUT 'FNPRINT 'DEFINED-ON-LINE '159) 
(PUT 'FNPRINT 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FNPRINT 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE FNPRINT (OP P L)
    (PROG ()
      (COND ((EQ OP 'EXPT) (RETURN (FEXPPRI P L)))
            ((NOT (GET OP 'ALT)) (PROGN (FMPRINT (CAR L) P) (SETQ L (CDR L)))))
      (PROG (V)
        (SETQ V L)
       LAB
        (COND ((NULL V) (RETURN NIL)))
        ((LAMBDA (V)
           (PROGN
            (COND ((OR (ATOM V) (NOT (EQ OP (GET (CAR V) 'ALT)))) (FOPRIN OP)))
            (FMPRINT V P)))
         (CAR V))
        (SETQ V (CDR V))
        (GO LAB)))) 
(PUT 'FEXPPRI 'NUMBER-OF-ARGS 2) 
(PUT 'FEXPPRI 'DEFINED-ON-LINE '170) 
(PUT 'FEXPPRI 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FEXPPRI 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FEXPPRI (P L)
    (COND ((EQ (CAR L) 'E) (FMPRINT (CONS 'EXP (CDR L)) P))
          ((EQUAL FORTLANG* 'C)
           (COND
            ((AND (FIXP (CADR L)) (GREATERP (CADR L) 0) (LESSP (CADR L) 4))
             (FMPRINT
              (CONS 'TIMES
                    (PROG (I FORALL-RESULT FORALL-ENDPTR)
                      (SETQ I 1)
                      (COND ((MINUSP (DIFFERENCE (CADR L) I)) (RETURN NIL)))
                      (SETQ FORALL-RESULT
                              (SETQ FORALL-ENDPTR (CONS (CAR L) NIL)))
                     LOOPLABEL
                      (SETQ I (PLUS2 I 1))
                      (COND
                       ((MINUSP (DIFFERENCE (CADR L) I))
                        (RETURN FORALL-RESULT)))
                      (RPLACD FORALL-ENDPTR (CONS (CAR L) NIL))
                      (SETQ FORALL-ENDPTR (CDR FORALL-ENDPTR))
                      (GO LOOPLABEL)))
              P))
            (T (FMPRINT (CONS 'POW L) P))))
          (T
           (PROG (PPERIOD)
             (FMPRINT (CAR L) P)
             (FOPRIN 'EXPT)
             (SETQ PPERIOD *PERIOD)
             (COND ((NUMBERP (CADR L)) (SETQ *PERIOD NIL))
                   (T (SETQ *PERIOD T)))
             (FMPRINT (CADR L) P)
             (SETQ *PERIOD PPERIOD))))) 
(PUT 'POW 'SIMPFN 'SIMPIDEN) 
(PUT 'FOPRIN 'NUMBER-OF-ARGS 1) 
(PUT 'FOPRIN 'DEFINED-ON-LINE '189) 
(PUT 'FOPRIN 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FOPRIN 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE FOPRIN (OP)
    ((LAMBDA (X) (COND ((NULL X) (FPRIN2* OP)) (T (FPRIN2* X))))
     (GET OP 'PRTCH))) 
(PUT 'FVARPRI 'NUMBER-OF-ARGS 3) 
(PUT 'FVARPRI 'DEFINED-ON-LINE '192) 
(PUT 'FVARPRI 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FVARPRI 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE FVARPRI (U V W)
    (PROG (SCOUNTR LLENGTH NCHARS EXPLIS FVAR SVAR)
      (SETQ SCOUNTR 0)
      (SETQ LLENGTH 0)
      (SETQ NCHARS 0)
      (SETQ FORTLANG* (REVAL1 FORT_LANG T))
      (COND
       ((NOT (MEMQ FORTLANG* '(FORT C))) (TYPERR FORTLANG* "target language")))
      (COND
       ((NOT ((LAMBDA (U) (AND (FIXP U) (GREATERP U 0))) CARD_NO))
        (TYPERR CARD_NO "FORTRAN card number")))
      (COND
       ((NOT ((LAMBDA (U) (AND (FIXP U) (GREATERP U 0))) FORT_WIDTH))
        (TYPERR FORT_WIDTH "FORTRAN line width")))
      (SETQ LLENGTH (LINELENGTH FORT_WIDTH))
      (COND
       ((STRINGP U)
        (RETURN
         (PROGN
          (FPRIN2* U)
          (COND ((EQ W 'ONLY) (FTERPRI T)))
          (LINELENGTH LLENGTH)))))
      (COND ((EQCAR U '*SQ) (SETQ U (PREPSQ* (SQHORNER* (CADR U))))))
      (SETQ SCOUNTR 0)
      (SETQ NCHARS
              (COND ((EQUAL FORTLANG* 'C) 999999)
                    (T
                     (TIMES
                      (DIFFERENCE (DIFFERENCE (LINELENGTH NIL) SPARE*) 12)
                      CARD_NO))))
      (SETQ SVAR VARNAM*)
      (SETQ FVAR
              (COND ((NULL V) (COND ((EQUAL FORTLANG* 'FORT) SVAR) (T NIL)))
                    (T (CAR V))))
      (COND ((AND (EQUAL POSN* 0) W) (FORTPRI FVAR U W)) (T (FORTPRI NIL U W)))
      (LINELENGTH LLENGTH))) 
(PUT 'FORTPRI 'NUMBER-OF-ARGS 3) 
(PUT 'FORTPRI 'DEFINED-ON-LINE '221) 
(PUT 'FORTPRI 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FORTPRI 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE FORTPRI (FVAR XEXP W)
    (PROG (FBRKT)
      (COND
       ((EQCAR XEXP 'LIST)
        (PROGN
         (SETQ POSN* 0)
         (FPRIN2* "C ***** INVALID FORTRAN CONSTRUCT (")
         (FPRIN2* (CAR XEXP))
         (RETURN (FPRIN2* ") NOT PRINTED")))))
      (COND
       ((LESSP (FLENGTH XEXP NCHARS) 0)
        (SETQ XEXP (CONS (CAR XEXP) (FOUT (CDR XEXP) (CAR XEXP) W)))))
      (COND
       (FVAR
        (PROGN
         (SETQ POSN* 0)
         (FPRIN2* "      ")
         (FMPRINT FVAR 0)
         (FPRIN2* "="))))
      (FMPRINT XEXP 0)
      (COND
       ((OR (AND (EQUAL FORTLANG* 'FORT) W) (EQUAL W 'LAST)) (FTERPRI W))))) 
(PUT 'FOUT 'NUMBER-OF-ARGS 3) 
(PUT 'FOUT 'DEFINED-ON-LINE '239) 
(PUT 'FOUT 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FOUT 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL GENERAL) GENERAL)) 
(DE FOUT (ARGS OP W)
    (PROG (NCHARSL DISTOP X Z)
      (SETQ NCHARSL 0)
      (SETQ NCHARSL NCHARS)
      (COND ((MEMQ OP '(PLUS TIMES)) (SETQ DISTOP OP)))
      (PROG ()
       WHILELABEL
        (COND ((NOT ARGS) (RETURN NIL)))
        (PROGN
         (SETQ X (CAR ARGS))
         (COND
          ((OR (AND (ATOM X) (SETQ NCHARSL (FLENGTH X NCHARSL)))
               (AND (OR (NULL (CDR ARGS)) DISTOP)
                    (GREATERP (SETQ NCHARSL (FLENGTH X NCHARSL)) 0)))
           (SETQ Z (CONS X Z)))
          ((AND DISTOP (GREATERP (FLENGTH X NCHARS) 0))
           (PROGN
            (SETQ Z (CONS (FOUT1 (CONS DISTOP ARGS) W) Z))
            (SETQ ARGS (LIST NIL))))
          (T
           (PROGN
            (SETQ Z (CONS (FOUT1 X W) Z))
            (SETQ NCHARSL (FLENGTH OP NCHARSL)))))
         (SETQ NCHARSL (FLENGTH OP NCHARSL))
         (SETQ ARGS (CDR ARGS)))
        (GO WHILELABEL))
      (RETURN (REVERSIP* Z)))) 
(PUT 'FOUT1 'NUMBER-OF-ARGS 2) 
(PUT 'FOUT1 'DEFINED-ON-LINE '259) 
(PUT 'FOUT1 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FOUT1 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FOUT1 (XEXP W)
    (PROG (FVAR)
      (SETQ FVAR (GENVAR))
      (SETQ EXPLIS (CONS (CONS XEXP FVAR) EXPLIS))
      (FORTPRI FVAR XEXP W)
      (RETURN FVAR))) 
(GLOBAL '(FORTRAN-COMMENT*)) 
(PUT 'FPRIN2* 'NUMBER-OF-ARGS 1) 
(PUT 'FPRIN2* 'DEFINED-ON-LINE '273) 
(PUT 'FPRIN2* 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FPRIN2* 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE FPRIN2* (U)
    (PROG (M N)
      (SETQ M 0)
      (SETQ N 0)
      (COND
       ((EQUAL POSN* 0)
        (SETQ FORTRAN-COMMENT* (AND (STRINGP U) (EQ (CADR (EXPLODE U)) 'C)))))
      (SETQ N (FLATSIZEC U))
      (SETQ M (PLUS POSN* N))
      (COND ((AND (FIXP U) *PERIOD) (SETQ M (PLUS M 1))))
      (COND ((LESSP M (DIFFERENCE (LINELENGTH NIL) SPARE*)) (SETQ POSN* M))
            (T
             (PROGN
              (TERPRI)
              (COND (FORTRAN-COMMENT* (PROGN (FPRIN2 "C") (SPACES 4)))
                    (T (SPACES 5)))
              (PRIN2 (COND ((EQUAL FORTLANG* 'C) "  ") (T ". ")))
              (SETQ POSN* (PLUS N 7)))))
      (FPRIN2 U)
      (COND ((AND (FIXP U) *PERIOD) (PRIN2 "."))))) 
(PUT 'PRIN2-DOWNCASE 'NUMBER-OF-ARGS 1) 
(PUT 'PRIN2-DOWNCASE 'DEFINED-ON-LINE '291) 
(PUT 'PRIN2-DOWNCASE 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'PRIN2-DOWNCASE 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE PRIN2-DOWNCASE (U)
    (PROG (C)
      (SETQ C (EXPLODE2 U))
     LAB
      (COND ((NULL C) (RETURN NIL)))
      ((LAMBDA (C)
         (COND ((LITER C) (PRIN2 (RED-CHAR-DOWNCASE C))) (T (PRIN2 C))))
       (CAR C))
      (SETQ C (CDR C))
      (GO LAB))) 
(PUT 'PRIN2-UPCASE 'NUMBER-OF-ARGS 1) 
(PUT 'PRIN2-UPCASE 'DEFINED-ON-LINE '295) 
(PUT 'PRIN2-UPCASE 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'PRIN2-UPCASE 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE PRIN2-UPCASE (U)
    (PROG (C)
      (SETQ C (EXPLODE2 U))
     LAB
      (COND ((NULL C) (RETURN NIL)))
      ((LAMBDA (C)
         (COND ((LITER C) (PRIN2 (RED-CHAR-UPCASE C))) (T (PRIN2 C))))
       (CAR C))
      (SETQ C (CDR C))
      (GO LAB))) 
(PUT 'FPRIN2 'NUMBER-OF-ARGS 1) 
(PUT 'FPRIN2 'DEFINED-ON-LINE '299) 
(PUT 'FPRIN2 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FPRIN2 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE FPRIN2 (U)
    ((LAMBDA (*LOWER)
       (COND (*FORTUPPER (PRIN2-UPCASE U)) (T (PRIN2-DOWNCASE U))))
     NIL)) 
(PUT 'RED-CHAR-UPCASE 'NUMBER-OF-ARGS 1) 
(PUT 'RED-CHAR-UPCASE 'DEFINED-ON-LINE '308) 
(PUT 'RED-CHAR-UPCASE 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'RED-CHAR-UPCASE 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE RED-CHAR-UPCASE (U)
    ((LAMBDA (X) (COND (X (CAR X)) (T U))) (RASSOC U CHARASSOC*))) 
(PUT 'FTERPRI 'NUMBER-OF-ARGS 1) 
(PUT 'FTERPRI 'DEFINED-ON-LINE '311) 
(PUT 'FTERPRI 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FTERPRI 'PROCEDURE_TYPE '(ARROW GENERAL GENERAL)) 
(DE FTERPRI (U)
    (PROGN (COND ((AND (NOT (EQUAL POSN* 0)) U) (TERPRI))) (SETQ POSN* 0))) 
(PUT 'GENVAR 'NUMBER-OF-ARGS 0) 
(PUT 'GENVAR 'DEFINED-ON-LINE '315) 
(PUT 'GENVAR 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'GENVAR 'PROCEDURE_TYPE '(ARROW UNIT GENERAL)) 
(DE GENVAR NIL
    (INTERN
     (COMPRESS
      (APPEND (EXPLODE SVAR) (EXPLODE (SETQ SCOUNTR (PLUS SCOUNTR 1))))))) 
(MKOP 'NO_PERIOD) 
(PUT 'NO_PERIOD 'FORT 'FO_NO_PERIOD) 
(PUT 'FO_NO_PERIOD 'NUMBER-OF-ARGS 2) 
(PUT 'FO_NO_PERIOD 'DEFINED-ON-LINE '322) 
(PUT 'FO_NO_PERIOD 'DEFINED-IN-FILE 'MATHPR/FORTPRI.RED) 
(PUT 'FO_NO_PERIOD 'PROCEDURE_TYPE '(ARROW (TIMES GENERAL GENERAL) GENERAL)) 
(DE FO_NO_PERIOD (U P) (PROG (*PERIOD) (FMPRINT (CADR U) P))) 
(ENDMODULE) 